<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highest Bid Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #eef5ff 100%);
            padding: 20px;
            min-height: 100vh;
            color: #1a2b3c;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .item-header h2 {
            margin: 0;
        }

        .edit-btn {
            font-size: 0.7em;
            padding: 1px 6px;
            margin-left: 6px;
            cursor: pointer;
            border-radius: 3px;
            border: none;
            background: #4CAF50;
            color: white;
            transition: all 0.3s;
            box-shadow: 0 1px 2px rgba(76, 175, 80, 0.2);
        }

        .edit-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin: 0;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .xml-controls {
            display: flex;
            gap: 10px;
        }

        .add-btn {
            background: #10b981;
            font-weight: 600;
        }

        .add-btn:hover {
            background: #059669;
        }

        .bid-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .bid-sections .list-section {
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 8px 24px rgba(17, 17, 26, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .bid-sections .list-section.active {
            order: -1;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1;
        }

        .bid-section {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 8px 24px rgba(17, 17, 26, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .bid-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .list-title {
            margin-bottom: 10px;
            font-weight: bold;
        }

        .highest-bid {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(167, 243, 208, 0.8);
        }

        .highest-bid p {
            margin: 5px 0;
            color: #2c3e50;
        }

        .form-container {
            padding: 0;
            background: transparent;
            border-radius: 0;
            margin: 0 0 20px 0;
            border: none;
            width: 100%;
        }

        .bid-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 0;
            width: 100%;
            padding: 0;
        }

        .bid-form input, .bid-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
            margin: 0 0 10px 0;
        }
        
        .item-select {
            margin-bottom: 10px;
        }

        .bid-form input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .bid-form button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            margin: 5px 0 0 0;
            width: 100%;
            box-sizing: border-box;
        }

        .bid-form button:hover {
            background: #2563eb;
        }

        input {
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #f8fafc;
            color: #1a2b3c;
        }

        input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            background-color: white;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(30, 41, 59, 0.1);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.01em;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            background: #2563eb;
        }

        .list-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 8px 24px rgba(17, 17, 26, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.8);
            margin-bottom: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .list-section.active {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1;
        }

        /* Ensure form elements maintain consistent width */
        .form-container {
            width: 100%;
            box-sizing: border-box;
        }

        .bid-form {
            width: 100%;
            box-sizing: border-box;
        }

        .list-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
        }

        .list-content {
            margin: 15px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .list-header {
            display: grid;
            grid-template-columns: 100px 250px 200px 150px;
            gap: 20px;
            padding: 14px 25px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
            letter-spacing: 0.02em;
            font-weight: 500;
            color: #444;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .list-item {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 12px 25px;
        }

        .list-entry-number {
            color: #666;
            font-family: monospace;
        }

        .list-amount {
            font-weight: 500;
            color: #2E7D32;
        }

        .list-header,
        .list-item {
            display: grid;
            grid-template-columns: 80px minmax(120px, 1fr) minmax(120px, 1fr) 120px 100px;
            gap: 10px;
            padding: 10px 15px;
            align-items: center;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95em;
            align-items: center;
        }

        .list-item:hover {
            background-color: #f8fafc;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-entry-number {
            color: #666;
            font-family: monospace;
        }

        .list-amount {
            font-weight: 500;
            color: #2E7D32;
        }

        .bid-history {
            margin-top: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .bid-history-header {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 120px 100px;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 500;
            color: #444;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .bid-entry {
            display: grid;
            grid-template-columns: 80px 150px 150px 120px 100px;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95em;
            align-items: center;
            transition: background-color 0.2s;
        }

        .bid-entry:first-child {
            border-left: 3px solid #4CAF50;
        }

        .bid-entry:last-child {
            border-bottom: none;
        }

        .save-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
            font-size: 14px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .list-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            margin-bottom: 10px;
        }

        .history-entry {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .history-entry:hover {
            background-color: #f5f5f5;
        }

        .list-content {
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .list-item {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .list-item:hover {
            background-color: #f5f5f5;
        }

        .list-entry-number {
            grid-column: 1;
        }

        .list-bidder {
            grid-column: 2;
        }

        .list-rep {
            grid-column: 3;
        }

        .list-amount {
            grid-column: 4;
        }

        .bid-actions {
            grid-column: 5;
            display: flex;
            gap: 5px;
        }

        .bid-edit-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .bid-edit-btn:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .bid-delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }

        .bid-edit-btn:hover {
            background-color: #e0a800;
        }

        .bid-delete-btn:hover {
            background-color: #c82333;
        }

        .bid-form {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="number"] {
            width: 180px;
        }

        .bid-history {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .list-header {
            display: grid;
            grid-template-columns: 100px 200px 200px 150px 120px;
            gap: 20px;
            padding: 14px 25px;
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .bid-list-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: white;
            position: relative;
        }
        
        .bid-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: min-content;
        }
        
        .list-header {
            display: grid;
            grid-template-columns: 100px 200px 200px 150px 120px;
            gap: 20px;
            padding: 14px 25px;
            background-color: #f8f9fa;
            font-weight: bold;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }
        
        .list-item {
            display: grid;
            grid-template-columns: 100px 200px 200px 150px 120px;
            gap: 20px;
            padding: 12px 25px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        /* Webkit browsers (Chrome, Safari) */
        .bid-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .bid-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .bid-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .bid-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .list-item {
            display: grid;
            grid-template-columns: 100px 200px 200px 150px 120px;
            gap: 20px;
            padding: 10px 25px;
            border-top: 1px solid #ddd;
        }

        .list-item:hover {
            background-color: #f8f9fa;
        }

        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }
    </style>
    <script>
        // Global state
        let bidsData = {};
        let nextItemId = 1;
        let currentLanguage = 'en';
        
        // Translation strings
        const translations = {
            'en': {
                'title': 'Highest Bid Tracker',
                'addNewItem': 'Add New Item',
                'submitNewBid': 'Submit New Bid',
                'item': 'Item',
                'bidderName': 'Bidder Name',
                'representative': 'Representative',
                'bidAmount': 'Bid Amount',
                'submitBid': 'Submit Bid',
                'highestBidder': 'Highest Bidder',
                'amount': 'Amount',
                'submittedBids': 'Submitted Bids',
                'entry': 'Entry',
                'bidder': 'Bidder',
                'actions': 'Functions',
                'selectItem': 'Select an item...',
                'entryNumber': 'Entry Number *',
                'bidderNamePlaceholder': 'Bidder Name *',
                'repPlaceholder': 'Representative (Optional)'
            },
            'zh': {
                'title': '司法變賣',
                'addNewItem': '添加項目',
                'submitNewBid': '新增競投',
                'item': '項目',
                'bidderName': '投標人名稱',
                'representative': '代表人',
                'bidAmount': '競投金額',
                'submitBid': '增競投',
                'highestBidder': '最高出價者',
                'amount': '金額',
                'submittedBids': '已提交投標',
                'entry': '收件序號',
                'bidder': '投標人',
                'actions': '功能',
                'selectItem': '選擇項目...',
                'entryNumber': '收件序號 *',
                'bidderNamePlaceholder': '投標人名稱 *',
                'repPlaceholder': '代表人 (可選)'
            },
            'pt': {
                'title': 'Venda judicial',
                'addNewItem': 'Adição de verbas',
                'submitNewBid': 'Submeter nova proposta',
                'item': 'Item',
                'bidderName': 'Nome do proponente',
                'representative': 'Representante',
                'bidAmount': 'Montante da proposta',
                'submitBid': 'Submeter proposta',
                'highestBidder': 'Maior lance',
                'amount': 'Montante',
                'submittedBids': 'Proposta submetida',
                'entry': 'N.° de entrada',
                'bidder': 'Proponente',
                'actions': 'Função',
                'selectItem': 'Selecione um item...',
                'entryNumber': 'N.° de entrada *',
                'bidderNamePlaceholder': 'Nome do proponente *',
                'repPlaceholder': 'Representante (Opcional)'
            }
        };
        
        // Function to change language with throttling
        let isUpdatingLanguage = false;
        let pendingLanguageUpdate = null;
        
        function changeLanguage(lang) {
            if (isUpdatingLanguage) {
                pendingLanguageUpdate = lang;
                return;
            }
            
            isUpdatingLanguage = true;
            currentLanguage = lang;
            // Save the language preference to localStorage
            localStorage.setItem('preferredLanguage', lang);
            
            // Use requestAnimationFrame for smoother updates
            requestAnimationFrame(() => {
                updateUIForLanguage();
                isUpdatingLanguage = false;
                
                // Process any pending language updates
                if (pendingLanguageUpdate && pendingLanguageUpdate !== lang) {
                    const nextLang = pendingLanguageUpdate;
                    pendingLanguageUpdate = null;
                    changeLanguage(nextLang);
                }
            });
        }
        
        // Function to update UI elements with current language
        function updateUIForLanguage() {
            const t = translations[currentLanguage];
            if (!t) return; // Skip if translation not found
            
            // Batch DOM updates using requestAnimationFrame
            requestAnimationFrame(() => {
                // Update static elements
                const titleEl = document.querySelector('h1');
                const addBtn = document.querySelector('.add-btn');
                const submitBidTitle = document.querySelector('h2');
                const itemSelect = document.querySelector('#itemSelect option[value=""]');
                const entryInput = document.querySelector('.entry-input');
                const bidderInput = document.querySelector('.bidder-input');
                const repInput = document.querySelector('.rep-input');
                const amountInput = document.querySelector('.amount-input');
                const submitBtn = document.querySelector('.bid-form button[type="submit"]');
                
                // Update elements if they exist
                if (titleEl) titleEl.textContent = t.title;
                if (addBtn) addBtn.textContent = t.addNewItem;
                if (submitBidTitle) submitBidTitle.textContent = t.submitNewBid;
                if (itemSelect) itemSelect.textContent = t.selectItem;
                if (entryInput) entryInput.placeholder = t.entryNumber;
                if (bidderInput) bidderInput.placeholder = t.bidderNamePlaceholder;
                if (repInput) repInput.placeholder = t.repPlaceholder;
                if (amountInput) amountInput.placeholder = t.bidAmount;
                if (submitBtn) submitBtn.textContent = t.submitBid;
                
                // Update highest bid sections
                const highestBidSections = document.querySelectorAll('.highest-bid');
                highestBidSections.forEach(section => {
                    const firstP = section.querySelector('p:first-child');
                    const lastP = section.querySelector('p:last-child');
                    
                    if (firstP) {
                        firstP.innerHTML = `<strong>${t.highestBidder}:</strong> ` + 
                            (firstP.textContent.split(':')[1] || '');
                    }
                    if (lastP) {
                        lastP.innerHTML = `<strong>${t.amount}:</strong> ` + 
                            (lastP.textContent.split(':')[1] || '');
                    }
                });
                
                // Update bid history headers in chunks to avoid blocking
                const historyHeaders = document.querySelectorAll('.bid-history');
                const chunkSize = 5; // Process 5 headers at a time
                
                const processChunk = (index) => {
                    const chunk = Array.from(historyHeaders).slice(index, index + chunkSize);
                    
                    chunk.forEach(header => {
                        const title = header.querySelector('.list-title');
                        const listHeader = header.querySelector('.list-header');
                        
                        if (title) title.textContent = `${t.submittedBids}:`;
                        
                        if (listHeader) {
                            const children = Array.from(listHeader.children);
                            if (children[0]) children[0].textContent = t.entry;
                            if (children[1]) children[1].textContent = t.bidder;
                            if (children[2]) children[2].textContent = t.representative;
                            if (children[3]) children[3].textContent = t.amount;
                            if (children[4]) children[4].textContent = t.actions;
                        }
                    });
                    
                    // Process next chunk
                    index += chunkSize;
                    if (index < historyHeaders.length) {
                        setTimeout(() => processChunk(index), 0);
                    }
                };
                
                if (historyHeaders.length > 0) {
                    processChunk(0);
                }
            });
        }
        
        let saveReminderInterval;

        // Function to show save reminder
        function setupSaveReminder() {
            // Clear any existing interval
            if (saveReminderInterval) {
                clearInterval(saveReminderInterval);
            }
            // Set up new interval (5 minutes = 300000 milliseconds)
            saveReminderInterval = setInterval(() => {
                showNotification('💾 Remember to save your work!');
            }, 5 * 60 * 1000);
        }

        function handleXmlFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(e.target.result, 'text/xml');
                        // Check for parser errors
                        const parserError = xmlDoc.getElementsByTagName('parsererror');
                        if (parserError.length > 0) {
                            throw new Error('Error parsing XML: ' + parserError[0].textContent);
                        }
                        loadXmlData(xmlDoc);
                    } catch (error) {
                        console.error('Error processing XML:', error);
                        alert('Error loading XML file: ' + error.message);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Error reading file:', error);
                    alert('Error reading file: ' + error.message);
                };
                reader.readAsText(file);
            }
        }

        function saveToXml() {
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<bids>\n';

            for (const [id, data] of Object.entries(bidsData)) {
                xmlContent += `  <item id="${id}">\n`;
                xmlContent += `    <description>${data.description}</description>\n`;
                xmlContent += '    <highest>\n';
                xmlContent += `      <name>${data.highestBidder}</name>\n`;
                xmlContent += `      <amount>${data.highestBid}</amount>\n`;
                xmlContent += '    </highest>\n';

                if (data.history.length > 0) {
                    xmlContent += '    <history>\n';
                    for (const bid of data.history) {
                        xmlContent += '      <bid>\n';
                        xmlContent += `        <entry>${bid.entry}</entry>\n`;
                        xmlContent += `        <bidder>${bid.bidder}</bidder>\n`;
                        xmlContent += `        <rep>${bid.rep}</rep>\n`;
                        xmlContent += `        <amount>${bid.amount}</amount>\n`;
                        xmlContent += '      </bid>\n';
                    }
                    xmlContent += '    </history>\n';
                }

                xmlContent += '  </item>\n';
            }

            xmlContent += '</bids>';

            const blob = new Blob([xmlContent], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bids.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</head>

<body>
    <!-- Language switcher moved outside the main container -->
    <div class="language-switcher-container">
        <select id="languageSelect" style="padding: 8px; border-radius: 4px; border: 1px solid #d1d5db; position: fixed; top: 20px; right: 20px; z-index: 1000;">
            <option value="zh">中文</option>
            <option value="pt">Português</option>
            <option value="en">English</option>
        </select>
    </div>
    
    <div class="container">
        <div class="header-container">
            <h1>Highest Bid Tracker</h1>
            <div class="controls">
                <button onclick="addNewItem()" class="add-btn">Add New Item</button>
                <div class="xml-controls">
                    <input type="file" id="xmlFile" accept=".xml" style="display: none"
                        onchange="handleXmlFileSelect(event)" />
                    <button onclick="document.getElementById('xmlFile').click()">Load XML</button>
                    <button onclick="saveToXml()">Save XML</button>
                </div>
            </div>
        </div>
        
        <!-- New Bid Entry Form -->
        <div class="bid-section" style="margin-bottom: 30px;">
            <h2>Submit New Bid</h2>
            <form id="mainBidForm" class="bid-form" novalidate>
                <select id="itemSelect" class="item-select" required>
                    <option value="">Select an item...</option>
                </select>
                <input type="text" class="entry-input" placeholder="Entry Number *" required>
                <input type="text" class="bidder-input" placeholder="Bidder Name *" required>
                <input type="text" class="rep-input" placeholder="Representative (Optional)">
                <input type="number" class="amount-input" placeholder="Bid Amount *" min="0.01" step="0.01" required inputmode="decimal">
                <button type="submit">Submit Bid</button>
            </form>
        </div>
        
        <div id="bidSections" class="bid-sections"></div>
    </div>

    <script>
        // Initialize state
        if (!window.bidsData) {
            window.bidsData = {};
            window.nextItemId = 1;
        }
        
        // Store the last update time to prevent rapid updates
        let lastDropdownUpdate = 0;
        
        // Update item dropdown when items are loaded
        const observer = new MutationObserver((mutations) => {
            // Only update if we're not already updating and it's been at least 100ms since last update
            const now = Date.now();
            if (now - lastDropdownUpdate > 100) {
                lastDropdownUpdate = now;
                updateItemDropdown();
                updateUIForLanguage(); // Update language for any new elements
            }
        });
        
        // Only observe direct child additions to bidSections
        observer.observe(document.getElementById('bidSections'), { 
            childList: true, 
            subtree: false // Changed from true to false to reduce unnecessary updates
        });
        
        // Initialize UI with a small delay to ensure DOM is ready
        setTimeout(updateItemDropdown, 50);
        
        // Set up language switcher with event delegation
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'languageSelect') {
                changeLanguage(e.target.value);
            }
        });

        // Try to load language preference from localStorage
        const savedLanguage = localStorage.getItem('preferredLanguage');
        if (savedLanguage && translations[savedLanguage]) {
            currentLanguage = savedLanguage;
        }
        
        // Set the selected language in the dropdown
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
            languageSelect.value = currentLanguage;
        }
        
        // Initial UI update with current language
        updateUIForLanguage();

        function addNewItem() {
            const itemId = nextItemId++;
            const itemKey = itemId.toString();

            bidsData[itemKey] = {
                highestBid: 0,
                highestBidder: '-',
                description: `Item ${itemId}`,
                history: []
            };

            // Create the item container
            const section = document.createElement('div');
            section.className = 'list-section';
            section.id = `section-${itemKey}`;
            
            // Item header
            const header = document.createElement('div');
            header.className = 'item-header';
            header.innerHTML = `<h3>${bidsData[itemKey].description}</h3>`;
            
            // Form container with instructions
            const formContainer = document.createElement('div');
            formContainer.className = 'form-container';
            formContainer.innerHTML = `
                <div class="bid-form-info" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; color: #495057;">
                    <p style="margin: 0;">Use the form at the top of the page to submit new bids for this item.</p>
                </div>
            `;
            
            // Bid history
            const history = document.createElement('div');
            history.className = 'bid-history';
            history.id = `history${itemKey}`;
            
            // Get current translations
            const t = translations[currentLanguage];
            
            history.innerHTML = `
                <div class="list-title">${t.submittedBids}:</div>
                <div class="list-content">
                    <div class="list-header">
                        <div>${t.entry}</div>
                        <div>${t.bidder}</div>
                        <div>${t.representative}</div>
                        <div>${t.amount}</div>
                        <div>${t.actions}</div>
                    </div>
                </div>
                <div class="bid-list" id="bid-list-${itemKey}"></div>
            `;
            
            // Assemble the section
            section.appendChild(header);
            section.appendChild(formContainer);
            section.appendChild(history);
            
            // Add to the page
            document.getElementById('bidSections').appendChild(section);
            
            // Update the item dropdown
            updateItemDropdown();
            
            // Select the newly added item in the dropdown
            setTimeout(() => {
                document.getElementById('itemSelect').value = itemKey;
            }, 0);
            
            showNotification(`Added Item ${itemId}`);
            return; // Exit the function early since we're not using itemHTML

            // Add new item to the page
            document.getElementById('bidSections').insertAdjacentHTML('beforeend', itemHTML);

            showNotification(`Added Item ${itemId}`);
        }

        // This function is no longer used - form submission is now handled by the event delegation
        // Keeping it for backward compatibility
        function submitBid() {
            console.warn('submitBid() is deprecated. Form submission is now handled by event delegation.');
        }



        // Handle click on bidding items
        function handleItemClick(event) {
            // Don't trigger if clicking on form elements
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON' ||
                event.target.closest('form') || event.target.closest('.bid-actions')) {
                return;
            }

            const section = event.currentTarget;
            const allSections = document.querySelectorAll('.list-section');

            // Toggle active state
            allSections.forEach(s => {
                if (s === section) {
                    s.classList.toggle('active');
                } else {
                    s.classList.remove('active');
                }
            });
        }


        // Update item dropdown when items change
        function updateItemDropdown() {
            const select = document.getElementById('itemSelect');
            if (!select) return;
            
            // Store current selection
            const currentValue = select.value;
            const currentSelectedIndex = select.selectedIndex;
            
            // Create a map of existing options for quick lookup
            const existingOptions = new Map();
            for (const option of select.options) {
                if (option.value) { // Skip the default 'Select an item' option
                    existingOptions.set(option.value, option);
                }
            }
            
            // Track which items we've processed
            const processedItems = new Set();
            
            // Update or add items
            for (const [id, data] of Object.entries(bidsData)) {
                const option = existingOptions.get(id);
                const description = data.description || `Item ${id}`;
                
                if (option) {
                    // Update existing option if description changed
                    if (option.textContent !== description) {
                        option.textContent = description;
                    }
                } else {
                    // Add new option
                    const newOption = new Option(description, id);
                    select.add(newOption, undefined);
                }
                processedItems.add(id);
            }
            
            // Remove items that no longer exist in bidsData
            for (let i = select.options.length - 1; i >= 0; i--) {
                const option = select.options[i];
                if (option.value && !processedItems.has(option.value)) {
                    select.remove(i);
                }
            }
            
            // Restore selection if possible
            if (currentValue && bidsData[currentValue]) {
                select.value = currentValue;
            } else if (select.options.length > 1) {
                // Select the first non-default option if no valid selection
                select.selectedIndex = 1;
            }
            
            // If we have items but no selection, select the first item
            if (select.options.length > 1 && select.selectedIndex === 0) {
                select.selectedIndex = 1;
            }
        }
        
        // Function to confirm if user wants to continue with the same bidder
        async function confirmContinueWithSameBidder(form, bidder) {
            if (!bidder) return false;
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.width = '400px';
            modalContent.style.maxWidth = '90%';
            modalContent.innerHTML = `
                <h3 style="margin-top: 0; color: #2c3e50;">Continue with same bidder?</h3>
                <p>Do you want to enter another bid for ${bidder}?</p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button id="continueNo" style="padding: 8px 16px; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer;">No, Clear All</button>
                    <button id="continueYes" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Yes, Keep Bidder</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Return a promise that resolves with the user's choice
            return new Promise((resolve) => {
                document.getElementById('continueYes').addEventListener('click', function() {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                    resolve(true);
                });

                document.getElementById('continueNo').addEventListener('click', function() {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                    resolve(false);
                });

                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        document.body.style.overflow = '';
                        resolve(false);
                    }
                });
            });
        }

        // Handle form submissions using event delegation
        document.addEventListener('submit', async function(e) {
            if (e.target && e.target.classList.contains('bid-form')) {
                e.preventDefault();
                e.stopPropagation();
                
                const form = e.target;
                const itemId = form.id === 'mainBidForm' ? document.getElementById('itemSelect').value : form.dataset.itemId;
                
                // Validate item selection for main form
                if (form.id === 'mainBidForm' && !itemId) {
                    showNotification('Please select an item');
                    return;
                }
                
                // Get form inputs
                const entry = form.querySelector('.entry-input').value.trim();
                const bidder = form.querySelector('.bidder-input').value.trim();
                const rep = form.querySelector('.rep-input').value.trim();
                const amount = parseFloat(form.querySelector('.amount-input').value);
                
                // Clear any previous validation messages
                [form.querySelector('.bidder-input'), form.querySelector('.entry-input'), form.querySelector('.amount-input')].forEach(input => {
                    if (input) {
                        input.setCustomValidity('');
                    }
                });
                
                // Custom validation
                let isValid = true;
                
                if (!bidder) {
                    if (form.querySelector('.bidder-input')) {
                        form.querySelector('.bidder-input').setCustomValidity('Bidder name is required');
                        form.querySelector('.bidder-input').reportValidity();
                    }
                    isValid = false;
                }
                
                if (!entry) {
                    if (form.querySelector('.entry-input')) {
                        form.querySelector('.entry-input').setCustomValidity('Entry number is required');
                        form.querySelector('.entry-input').reportValidity();
                    }
                    isValid = false;
                }
                
                if (isNaN(amount) || amount <= 0) {
                    if (form.querySelector('.amount-input')) {
                        form.querySelector('.amount-input').setCustomValidity('Please enter a valid amount');
                        form.querySelector('.amount-input').reportValidity();
                    }
                    isValid = false;
                }
                
                if (!isValid) {
                    return false;
                }
                
                const bid = {
                    entry: entry,
                    bidder,
                    rep,
                    amount,
                    timestamp: new Date().toISOString()
                };
                
                bidsData[itemId].history.push(bid);
                
                if (amount > bidsData[itemId].highestBid) {
                    bidsData[itemId].highestBid = amount;
                    bidsData[itemId].highestBidder = bidder;
                }
                
                showNotification(`Bid of $${amount} submitted for ${bidsData[itemId].description}`);
                updateDisplay();
                
                // Ask if user wants to continue with same bidder
                const continueWithSameBidder = await confirmContinueWithSameBidder(form, bidder);
                
                // Clear form based on user's choice
                if (form.id === 'mainBidForm') {
                    if (continueWithSameBidder) {
                        // Only clear amount field, keep entry, bidder and rep
                        form.querySelector('.amount-input').value = '';
                        form.querySelector('.amount-input').focus();
                    } else {
                        // Clear all fields
                        form.reset();
                        // Reset the item selection to the same item for quick multiple bids
                        if (itemId) {
                            setTimeout(() => {
                                document.getElementById('itemSelect').value = itemId;
                                form.querySelector('.entry-input').focus();
                            }, 0);
                        }
                    }
                }
            }
        });

        // Function to handle entry number lookup
        async function handleEntryNumberLookup(entryInput) {
            const entryNumber = entryInput.value.trim();
            
            if (entryNumber) {
                try {
                    const bidderInfo = await loadBidderByEntry(entryNumber);
                    if (bidderInfo) {
                        const form = entryInput.closest('form');
                        const bidderInput = form.querySelector('.bidder-input');
                        const repInput = form.querySelector('.rep-input');
                        
                        if (bidderInput && !bidderInput.value) {
                            bidderInput.value = bidderInfo.bidder;
                        }
                        
                        if (repInput && !repInput.value && bidderInfo.rep) {
                            repInput.value = bidderInfo.rep;
                        }
                        
                        // Focus on amount field for quick entry
                        const amountInput = form.querySelector('.amount-input');
                        if (amountInput) {
                            amountInput.focus();
                        }
                        return true; // Found matching entry
                    }
                } catch (error) {
                    console.error('Error loading bidder info:', error);
                }
            }
            return false; // No matching entry or error occurred
        }

        // Add event listeners for entry number input
        document.addEventListener('input', async function(e) {
            if (e.target && e.target.classList.contains('entry-input')) {
                await handleEntryNumberLookup(e.target);
            }
        });

        // Handle both Enter and Tab key presses
        document.addEventListener('keydown', async function(e) {
            const entryInput = e.target;
            if (!entryInput || !entryInput.classList.contains('entry-input')) {
                return;
            }

            // Check for Enter or Tab key
            if (e.key === 'Enter' || e.key === 'Tab') {
                // If Tab is pressed without any value, let it proceed normally
                if (e.key === 'Tab' && !entryInput.value.trim()) {
                    return;
                }

                // For Enter key, prevent default form submission
                if (e.key === 'Enter') {
                    e.preventDefault();
                }

                console.log('Key pressed:', e.key, 'Value:', entryInput.value);
                const entryFound = await handleEntryNumberLookup(entryInput);
                console.log('Entry lookup result:', entryFound);
                
                if (entryFound) {
                    // If entry was found, focus on amount field
                    const form = entryInput.closest('form');
                    const amountInput = form.querySelector('.amount-input');
                    if (amountInput) {
                        // Small timeout to ensure the focus happens after the current event loop
                        setTimeout(() => amountInput.focus(), 10);
                    }
                } else if (e.key === 'Enter') {
                    // Only move to bidder field on Enter if no match found
                    const form = entryInput.closest('form');
                    const bidderInput = form.querySelector('.bidder-input');
                    if (bidderInput) {
                        // Small timeout to ensure the focus happens after the current event loop
                        setTimeout(() => bidderInput.focus(), 10);
                    }
                }
                // For Tab key, let the default behavior handle the focus change
            }
        });

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function () {
            // Initialize empty data structure
            bidsData = {};
            document.getElementById('bidSections').innerHTML = '';
            nextItemId = 1;
            
            // Start the save reminder
            setupSaveReminder();

            // Add first item automatically
            addNewItem();

        });

        // Add click event delegation for all bid section interactions
        document.addEventListener('click', function(event) {
            // Edit and delete button clicks are now handled by direct event listeners
            // to prevent duplicate event handling
            
            // Handle section activation
            const section = event.target.closest('.bid-section');
            if (section && !event.target.closest('button, input, .list-actions')) {
                document.querySelectorAll('.bid-section').forEach(s => s.classList.remove('active'));
                section.classList.add('active');
            }
        });


        // XML-related functions
        function updateDisplay() {
            // Get the currently selected item before clearing
            const selectedItem = document.querySelector('.bid-section.active')?.id?.replace('section-', '');
            
            // Clear existing bid sections
            const bidSections = document.getElementById('bidSections');
            bidSections.innerHTML = '';

            // Sort items by ID for consistent ordering
            const sortedIds = Object.keys(bidsData).sort((a, b) => parseInt(a) - parseInt(b));

            sortedIds.forEach((itemId, index) => {
                const item = bidsData[itemId];
                const section = document.createElement('div');
                // Set active class if this was the selected item, or if no selection and it's the first item
                const isActive = (selectedItem && itemId === selectedItem) || (!selectedItem && index === 0);
                section.className = 'bid-section' + (isActive ? ' active' : '');
                section.id = `section-${itemId}`;

                // Create item header
                const header = document.createElement('div');
                header.className = 'item-header';
                header.innerHTML = `
                    <h2>
                        <span id="description${itemId}">${item.description}</span>
                        <button class="edit-btn" onclick="editDescription('${itemId}')">Edit</button>
                    </h2>
                `;

                // Create highest bid display
                const highestBid = document.createElement('div');
                highestBid.className = 'highest-bid';
                highestBid.innerHTML = `
                    <p>Highest Bidder: <span id="bidder${itemId}">${item.highestBidder}</span></p>
                    <p>Amount: $<span id="bidAmount${itemId}">${item.highestBid.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></p>
                `;


                // Add instructions for bid submission
                const bidFormInfo = document.createElement('div');
                bidFormInfo.className = 'bid-form-info';
                bidFormInfo.style.margin = '15px 0';
                bidFormInfo.style.padding = '10px';
                bidFormInfo.style.background = '#f8f9fa';
                bidFormInfo.style.borderRadius = '4px';
                bidFormInfo.style.color = '#495057';
                bidFormInfo.innerHTML = `
                    <p style="margin: 0;">Use the form at the top of the page to submit new bids for this item.</p>
                `;

                // Create bid history container
                const historyContainer = document.createElement('div');
                historyContainer.className = 'bid-history';
                historyContainer.id = `history-${itemId}`;
                // Ensure we have the latest translations
                const t = translations[currentLanguage];
                // Use current language for the header
                historyContainer.innerHTML = `
                    <div class="list-title">${t.submittedBids}:</div>
                    <div class="list-header">
                        <div>${t.entry}</div>
                        <div>${t.bidder}</div>
                        <div>${t.representative}</div>
                        <div>${t.amount}</div>
                        <div>${t.actions}</div>
                    </div>
                `;
                // Create a container for the bid list that will be scrollable
                const bidListContainer = document.createElement('div');
                bidListContainer.className = 'bid-list-container';
                
                // Create the bid list
                const bidList = document.createElement('div');
                bidList.id = `bid-list-${itemId}`;
                bidList.className = 'bid-list';
                
                if (item.history && item.history.length > 0) {
                    // Create a new array with string entries for consistent handling
                    const sortedHistory = [...item.history].map(bid => ({
                        ...bid,
                        entry: String(bid.entry) // Ensure entry is a string
                    })).sort((a, b) => {
                        // Sort by entry as strings
                        return b.entry.localeCompare(a.entry);
                    });
                    
                    console.log(`Item ${itemId} sorted history:`, sortedHistory);
                    sortedHistory.forEach(bid => {
                        const bidElement = document.createElement('div');
                        bidElement.className = 'list-item';
                        bidElement.innerHTML = `
                            <div class="list-entry-number">${bid.entry}</div>
                            <div class="list-bidder">${bid.bidder}</div>
                            <div class="list-rep">${bid.rep}</div>
                            <div class="list-amount">$${bid.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="list-actions">
                                <button class="bid-edit-btn" data-item-id="${itemId}" data-entry="${bid.entry}">Edit</button>
                                <button class="bid-delete-btn" data-item-id="${itemId}" data-entry="${bid.entry}">Del</button>
                            </div>
                        `;
                        
                        // Get the buttons and clone them to remove any existing event listeners
                        const deleteBtn = bidElement.querySelector('.bid-delete-btn');
                        const editBtn = bidElement.querySelector('.bid-edit-btn');
                        
                        // Create new buttons to replace existing ones (this removes any existing event listeners)
                        const newDeleteBtn = deleteBtn.cloneNode(true);
                        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                        
                        const newEditBtn = editBtn.cloneNode(true);
                        editBtn.parentNode.replaceChild(newEditBtn, editBtn);
                        
                        // Add click handler for delete button with custom confirmation
                        newDeleteBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            const itemId = this.getAttribute('data-item-id');
                            const entry = this.getAttribute('data-entry');
                            console.log('Delete button clicked - showing custom confirmation:', { itemId, entry });
                            
                            // Create a custom confirmation dialog
                            const modal = document.createElement('div');
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100%';
                            modal.style.height = '100%';
                            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                            modal.style.display = 'flex';
                            modal.style.justifyContent = 'center';
                            modal.style.alignItems = 'center';
                            modal.style.zIndex = '1000';
                            
                            const dialog = document.createElement('div');
                            dialog.style.backgroundColor = 'white';
                            dialog.style.padding = '20px';
                            dialog.style.borderRadius = '8px';
                            dialog.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                            dialog.innerHTML = `
                                <h3>Delete Bid</h3>
                                <p>Are you sure you want to delete this bid?</p>
                                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                                    <button id="confirmDelete" style="background-color: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Delete</button>
                                    <button id="cancelDelete" style="background-color: #e5e7eb; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
                                </div>
                            `;
                            
                            modal.appendChild(dialog);
                            document.body.appendChild(modal);
                            document.body.style.overflow = 'hidden';
                            
                            // Handle confirm delete
                            document.getElementById('confirmDelete').addEventListener('click', function() {
                                document.body.removeChild(modal);
                                document.body.style.overflow = '';
                                deleteBid(itemId, entry);
                            });
                            
                            // Handle cancel
                            document.getElementById('cancelDelete').addEventListener('click', function() {
                                document.body.removeChild(modal);
                                document.body.style.overflow = '';
                                console.log('Deletion cancelled by user');
                            });
                            
                            // Close when clicking outside
                            modal.addEventListener('click', function(e) {
                                if (e.target === modal) {
                                    document.body.removeChild(modal);
                                    document.body.style.overflow = '';
                                    console.log('Deletion cancelled by clicking outside');
                                }
                            });
                            
                        }, { once: true });
                        
                        // Add click handler for edit button
                        newEditBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            
                            const itemId = this.getAttribute('data-item-id');
                            const entry = this.getAttribute('data-entry');
                            console.log('Edit button clicked:', { itemId, entry });
                            
                            editBid(itemId, entry);
                        }, { once: true });
                        bidList.appendChild(bidElement);
                    });
                }

                // Add all elements to the section
                section.appendChild(header);
                section.appendChild(highestBid);
                section.appendChild(bidFormInfo);
                historyContainer.appendChild(bidListContainer);
                bidListContainer.appendChild(bidList);
                section.appendChild(historyContainer);
                
                // Section activation is now handled by the parent container's event delegation

                // Add to the DOM
                bidSections.appendChild(section);
            });
        }

        function editDescription(itemId) {
            const currentDesc = bidsData[itemId].description;
            const newDesc = prompt('Enter new description:', currentDesc);

            if (newDesc !== null && newDesc.trim() !== '') {
                bidsData[itemId].description = newDesc.trim();
                updateDisplay();
                showNotification('Description updated successfully');
            }
        }

        function loadXmlData(xmlDoc) {
            try {
                console.log('Loading XML data...');
                // Create a temporary object to store the new data
                const newBidsData = {};
                let maxId = 0;

                const items = xmlDoc.getElementsByTagName('item');
                if (!items || items.length === 0) {
                    throw new Error('No items found in XML file');
                }

                // First pass: load all data into bidsData
                for (const item of items) {
                    const id = item.getAttribute('id');
                    const description = item.getElementsByTagName('description')[0];
                    if (!description) {
                        console.warn(`Description missing for item ${id}, skipping...`);
                        continue;
                    }

                    newBidsData[id] = {
                        description: description.textContent,
                        highestBid: 0,
                        highestBidder: '-',
                        history: []
                    };

                    const highest = item.getElementsByTagName('highest')[0];
                    if (highest) {
                        const nameEl = highest.getElementsByTagName('name')[0];
                        const amountEl = highest.getElementsByTagName('amount')[0];
                        if (nameEl && amountEl) {
                            newBidsData[id].highestBidder = nameEl.textContent;
                            newBidsData[id].highestBid = parseFloat(amountEl.textContent) || 0;
                        }
                    }

                    // Load history and track the highest bid
                    const history = item.getElementsByTagName('history')[0];
                    if (history) {
                        const bids = history.getElementsByTagName('bid');
                        let highestBidInHistory = 0;
                        let highestBidderInHistory = '-';

                        for (const bid of bids) {
                            const entry = bid.getElementsByTagName('entry')[0];
                            const bidder = bid.getElementsByTagName('bidder')[0];
                            const rep = bid.getElementsByTagName('rep')[0];
                            const amount = bid.getElementsByTagName('amount')[0];

                            if (entry && bidder && rep && amount) {
                                const bidAmount = parseFloat(amount.textContent) || 0;
                                newBidsData[id].history.push({
                                    entry: parseInt(entry.textContent),
                                    bidder: bidder.textContent,
                                    rep: rep.textContent,
                                    amount: bidAmount
                                });

                                // Update highest bid if this is higher
                                if (bidAmount > highestBidInHistory) {
                                    highestBidInHistory = bidAmount;
                                    highestBidderInHistory = bidder.textContent;
                                }
                            }
                        }

                        // Update highest bid if necessary
                        if (highestBidInHistory > newBidsData[id].highestBid) {
                            newBidsData[id].highestBid = highestBidInHistory;
                            newBidsData[id].highestBidder = highestBidderInHistory;
                        }
                    }

                    // Update maxId
                    if (parseInt(id) > maxId) {
                        maxId = parseInt(id);
                    }
                }

                // Update the global state
                bidsData = newBidsData;
                nextItemId = maxId + 1;

                // Update the display with the new data
                updateDisplay();

                console.log('XML data loaded successfully');
                showNotification('XML data loaded successfully');
            } catch (error) {
                console.error('Error loading XML:', error);
                alert('Error loading XML file: ' + (error.message || 'Unknown error'));
            }
        }

        function editBid(itemKey, entry) {
            // Ensure consistent string comparison for entry
            entry = String(entry);
            console.log('editBid called with:', { itemKey, entry });
            
            // Ensure the item exists
            if (!bidsData[itemKey]) {
                console.error('Item not found:', itemKey);
                showNotification('Error: Item not found');
                return;
            }
            
            // Find the bid with consistent string comparison
            const bid = (bidsData[itemKey]?.history || []).find(b => String(b.entry) === entry);
            if (!bid) {
                console.error('Bid not found for entry:', entry, 'in item:', itemKey);
                showNotification('Error: Bid not found');
                return;
            }

            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.width = '400px';
            modalContent.style.maxWidth = '90%';

            // Create form
            modalContent.innerHTML = `
                <h3 style="margin-top: 0; color: #2c3e50;">Edit Bid #${entry}</h3>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label for="editEntry" style="display: block; margin-bottom: 5px; font-weight: 500;">Entry Number: *</label>
                        <input type="text" id="editEntry" value="${bid.entry}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label for="editBidder" style="display: block; margin-bottom: 5px; font-weight: 500;">Bidder: *</label>
                        <input type="text" id="editBidder" value="${bid.bidder}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label for="editRep" style="display: block; margin-bottom: 5px; font-weight: 500;">Representative:</label>
                        <input type="text" id="editRep" value="${bid.rep || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label for="editAmount" style="display: block; margin-bottom: 5px; font-weight: 500;">Amount ($): *</label>
                        <input type="number" id="editAmount" value="${bid.amount}" min="0.01" step="0.01" required inputmode="decimal" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; -moz-appearance: textfield;">
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="cancelEdit" style="padding: 8px 16px; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button id="saveEdit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden'; // Prevent scrolling

            // Handle save
            document.getElementById('saveEdit').addEventListener('click', function () {
                const newBidder = document.getElementById('editBidder').value.trim();
                const newEntry = document.getElementById('editEntry').value.trim();
                const newRep = document.getElementById('editRep').value.trim();
                const newAmount = parseFloat(document.getElementById('editAmount').value);

                if (!newBidder || !newEntry || isNaN(newAmount) || newAmount <= 0) {
                    alert('Please fill in all required fields with valid values');
                    return;
                }

                // Update the bid
                bid.bidder = newBidder;
                bid.entry = newEntry;
                bid.rep = newRep;
                bid.amount = newAmount;

                // Update highest bid if necessary
                if (newAmount > bidsData[itemKey].highestBid) {
                    bidsData[itemKey].highestBid = newAmount;
                    bidsData[itemKey].highestBidder = newBidder;
                }

                // Remove modal and update display
                document.body.removeChild(modal);
                document.body.style.overflow = '';
                updateDisplay();
                showNotification('Bid updated successfully');
            });

            // Handle cancel
            document.getElementById('cancelEdit').addEventListener('click', function () {
                document.body.removeChild(modal);
                document.body.style.overflow = '';
            });

            // Close modal when clicking outside
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                }
            });

            // Focus on entry input
            document.getElementById('editEntry').focus();
        }

        function deleteBid(itemKey, entry) {
            // Ensure entry is treated as a string consistently
            entry = String(entry);
            console.log('deleteBid called with:', { itemKey, entry });
            
            // The confirmation is now handled by the custom dialog
            // This function is only called when the user confirms deletion
            
            // Ensure the item exists
            if (!bidsData[itemKey]) {
                console.error('Item not found:', itemKey);
                showNotification('Error: Item not found');
                return;
            }
            
            // Convert entry to string for consistent comparison
            const entryStr = String(entry);
            console.log('Looking for entry:', entryStr);
            
            // Find the bid by comparing string values
            const bidIndex = bidsData[itemKey].history.findIndex(b => {
                return String(b.entry) === entryStr;
            });
            
            if (bidIndex === -1) {
                console.error('Bid not found for entry:', entry, 'in item:', itemKey);
                showNotification('Error: Bid not found');
                return;
            }
            
            try {
                // Remove the bid from history
                const [deletedBid] = bidsData[itemKey].history.splice(bidIndex, 1);
                console.log('Deleted bid:', deletedBid);
                
                // If we deleted the highest bid, find the new highest
                if (deletedBid.amount === bidsData[itemKey].highestBid) {
                    const newHighest = bidsData[itemKey].history.reduce((max, bid) => 
                        bid.amount > max.amount ? bid : max,
                        { amount: 0, bidder: 'No bids' }
                    );
                    
                    bidsData[itemKey].highestBid = newHighest.amount;
                    bidsData[itemKey].highestBidder = newHighest.bidder;
                }
                
                // Update the display
                updateDisplay();
                showNotification('Bid deleted successfully');
                
            } catch (error) {
                console.error('Error deleting bid:', error);
                showNotification('Error deleting bid. Please try again.');
            }
        }

        function showNotification(message) {
            try {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                // Add fade-in animation
                notification.style.animation = 'fadeIn 0.3s ease-out';

                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s ease-in';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing notification:', error);
                // Fallback to alert if there's an error
                alert(message);
            }
        }

        /**
         * Loads bidder information by entry number from bids.xml
         * @param {string} entryNumber - The entry number to search for
         * @returns {Promise<{bidder: string, rep: string}|null>} - Object containing bidder and rep, or null if not found
         */
        async function loadBidderByEntry(entryNumber) {
            try {
                // Fetch the bids.xml file
                const response = await fetch('bids.xml');
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Find all bid elements
                const bids = xmlDoc.getElementsByTagName('bid');
                
                // Search for the entry
                for (let i = 0; i < bids.length; i++) {
                    const entry = bids[i].getElementsByTagName('entry')[0]?.textContent;
                    if (entry === entryNumber) {
                        const bidder = bids[i].getElementsByTagName('bidder')[0]?.textContent || '';
                        const repElem = bids[i].getElementsByTagName('rep')[0];
                        const rep = repElem ? (repElem.textContent || '') : '';
                        
                        return {
                            bidder: bidder.trim(),
                            rep: rep.trim()
                        };
                    }
                }
                
                return null; // Entry not found
            } catch (error) {
                console.error('Error loading bidder information:', error);
                return null;
            }
        }
    </script>
</body>

</html>